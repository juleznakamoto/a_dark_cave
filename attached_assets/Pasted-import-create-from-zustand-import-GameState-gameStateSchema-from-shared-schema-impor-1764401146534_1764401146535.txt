import { create } from "zustand";
import { GameState, gameStateSchema } from "@shared/schema";
import { gameActions, shouldShowAction, canExecuteAction } from "@/game/rules";
import { EventManager, LogEntry } from "@/game/rules/events";
import { executeGameAction } from "@/game/actions";
import {
  updateResource,
  updateFlag,
  updatePopulationCounts,
  assignVillagerToJob,
  unassignVillagerFromJob,
} from "@/game/stateHelpers";
import { calculateTotalEffects } from "@/game/rules/effectsCalculation";
import { calculateBastionStats } from "@/game/bastionStats";
import { getMaxPopulation } from "@/game/population";
import { audioManager } from "@/lib/audio";
import { GAME_CONSTANTS } from "@/game/constants";
import { ACTION_TO_UPGRADE_KEY, incrementButtonUsage } from "@/game/buttonUpgrades";
import { logger } from "@/lib/logger";

// Types
interface GameStore extends GameState {
  // UI state
  activeTab: string;
  devMode: boolean;
  boostMode: boolean;
  lastSaved: string;
  eventDialog: {
    isOpen: boolean;
    currentEvent: LogEntry | null;
  };
  combatDialog: {
    isOpen: boolean;
    enemy: any | null;
    eventTitle: string;
    eventMessage: string;
    onVictory: (() => Partial<GameState>) | null;
    onDefeat: (() => Partial<GameState>) | null;
  };
  authDialogOpen: boolean;
  shopDialogOpen: boolean;
  showEndScreen: boolean; // Added showEndScreen flag
  idleModeDialog: {
    isOpen: boolean;
  };
  idleModeState: {
    isActive: boolean;
    startTime: number;
    needsDisplay: boolean; // Track if user needs to see results
  };
  inactivityDialogOpen: boolean;
  inactivityReason: 'timeout' | 'multitab' | null;

  // Notification state for shop
  shopNotificationSeen: boolean;
  shopNotificationVisible: boolean;

  // Notification state for auth
  authNotificationSeen: boolean;
  authNotificationVisible: boolean;

  // Notification state for mysterious note
  mysteriousNoteShopNotificationSeen: boolean;
  mysteriousNoteDonateNotificationSeen: boolean;

  // Auth state
  isUserSignedIn: boolean;

  // Play time tracking
  playTime: number;
  isNewGame: boolean; // Track if this is a newly started game
  startTime: number; // Timestamp when the current game was started

  // Referral tracking
  referralCount: number;
  referredUsers: string[];
  referrals: GameState["referrals"]; // Added to store referral details

  // Cooldown management
  cooldowns: Record<string, number>;
  cooldownDurations: Record<string, number>; // Track initial duration for each cooldown

  // Population helpers
  current_population: number;
  total_population: number;

  // Game loop state
  loopProgress: number; // 0-100 representing progress through the 15s production cycle
  isGameLoopActive: boolean;
  isPaused: boolean; // New state for pause/unpause
  isMuted: boolean; // Audio mute state

  // Actions
  executeAction: (actionId: string) => void;
  setActiveTab: (tab: string) => void;
  setBoostMode: (enabled: boolean) => void;
  setShowEndScreen: (showEndScreen: boolean) => void; // Added setShowEndScreen action
  setIsMuted: (isMuted: boolean) => void;
  setShopNotificationSeen: (seen: boolean) => void;
  setShopNotificationVisible: (visible: boolean) => void;
  setAuthNotificationSeen: (seen: boolean) => void;
  setAuthNotificationVisible: (visible: boolean) => void;
  setMysteriousNoteShopNotificationSeen: (seen: boolean) => void;
  setMysteriousNoteDonateNotificationSeen: (seen: boolean) => void;
  setIsUserSignedIn: (signedIn: boolean) => void;
  updateResource: (
    resource: keyof GameState["resources"],
    amount: number,
  ) => void;
  setFlag: (flag: keyof GameState["flags"], value: boolean) => void;
  setHoveredTooltip: (tooltipId: string, value: boolean) => void;
  initialize: (state: GameState) => void;
  restartGame: () => void;
  loadGame: () => Promise<void>;
  toggleDevMode: () => void;
  getMaxPopulation: () => number;
  updatePopulation: () => void;
  setCooldown: (action: string, duration: number) => void;
  tickCooldowns: () => void;
  addLogEntry: (entry: LogEntry) => void;
  checkEvents: () => void;
  applyEventChoice: (choiceId: string, eventId: string) => void;
  assignVillager: (job: keyof GameState["villagers"]) => void;
  unassignVillager: (job: keyof GameState["villagers"]) => void;
  setEventDialog: (isOpen: boolean, event?: LogEntry | null) => void;
  setCombatDialog: (isOpen: boolean, data?: any) => void;
  setAuthDialogOpen: (isOpen: boolean) => void;
  setShopDialogOpen: (isOpen: boolean) => void;
  setIdleModeDialog: (isOpen: boolean) => void;
  updateEffects: () => void;
  updateBastionStats: () => void;
  updateLoopProgress: (progress: number) => void;
  setGameLoopActive: (isActive: boolean) => void;
  togglePause: () => void;
  updatePlayTime: (deltaTime: number) => void;
}