ERUN  client/src/game/save.comprehensive.test.ts x8 

 â¯ client/src/game/save.comprehensive.test.ts (55 tests | 1 failed) 151ms
   â¯ Save Game System - Comprehensive Tests (55)
     âœ“ 1. Cloud Sync Failures (4)
       âœ“ should save locally even when cloud save fails 6ms
       âœ“ should handle multiple consecutive cloud save failures 1ms
       âœ“ should not update lastCloudState when cloud save fails 1ms
       âœ“ should recover from intermittent cloud failures 1ms
     âœ“ 2. Multi-Device Conflicts (7)
       âœ“ v1: should detect when cloud save is newer than local save - direct cloud priority 1ms
       âœ“ v2: should detect when cloud save is newer - both saves present 1ms
       âœ“ v3: should detect newer cloud save and sync locally 1ms
       âœ“ v4: should use cloud save when timestamps indicate it is newer 1ms
       âœ“ v5: should detect newer cloud save and process referrals 1ms
       âœ“ should handle simultaneous saves from different devices 1ms
       âœ“ should preserve higher playTime when loading 1ms
     âœ“ 3. Offline Progress Overwrite (11)
       âœ“ v1: should not lose offline progress - save then login 1ms
       âœ“ v2: should preserve offline progress when authenticating 1ms
       âœ“ v3: should not lose offline progress - verify store persistence 1ms
       âœ“ v4: should preserve offline session through login 1ms
       âœ“ v5: should sync offline progress to cloud on login 1ms
       âœ“ should handle transition from offline to online with existing cloud save 2ms
       âœ“ v1: should preserve offline progress across sessions - simple 1ms
       âœ“ v2: should preserve offline progress - stay offline 0ms
       âœ“ v3: should preserve offline data with cooldowns across sessions 1ms
       âœ“ v4: should preserve offline progress through multiple sessions 1ms
       âœ“ v5: should preserve offline progress - verify IndexedDB 1ms
     â¯ 4. Data Corruption and Validation (8)
       âœ“ v1: should handle corrupted cooldownDurations - apply defaults 0ms
       âœ“ v2: should handle null cooldownDurations gracefully 0ms
       âœ“ v3: should add cooldownDurations when missing 1ms
       Ã— v4: should handle corrupted cloud data 7ms
       âœ“ v5: should handle multiple corrupted fields 1ms
       âœ“ should handle missing required fields 0ms
       âœ“ should handle non-serializable data in game state 1ms
       âœ“ should preserve data through JSON serialization round-trip 1ms
     âœ“ 5. State Diffing Logic (3)
       âœ“ should calculate diff correctly for changed resources 1ms
       âœ“ should handle first save (no previous state for diff) 1ms
       âœ“ should detect nested object changes 1ms
     âœ“ 6. Referral System Integration (6)
       âœ“ should process unclaimed referrals on load 1ms
       âœ“ v1: should not process claimed referrals - cloud load 2ms
       âœ“ v2: should not add gold for already claimed referrals 0ms
       âœ“ v3: should skip processing for claimed referrals 0ms
       âœ“ v4: should handle multiple claimed referrals without changes 0ms
       âœ“ v5: should handle claimed referrals or empty array 0ms
     âœ“ 7. PlayTime Tracking (7)
       âœ“ v1: should preserve playTime - offline mode 0ms
       âœ“ v2: should preserve playTime through cloud save 0ms
       âœ“ v3: should preserve playTime in local storage 0ms
       âœ“ v4: should preserve playTime across multiple cycles 1ms
       âœ“ v5: should preserve playTime through auth change 1ms
       âœ“ should handle playTime overflow (very long sessions) 1ms
       âœ“ should reject saves with decreasing playTime 0ms
     âœ“ 8. Edge Cases and Race Conditions (5)
       âœ“ should handle rapid successive saves 99ms
       âœ“ should handle save during active gameplay 1ms
       âœ“ should skip save when inactivity dialog is open 0ms
       âœ“ should handle database connection failures 1ms
       âœ“ should handle concurrent load and save operations 1ms
     âœ“ 9. Authentication State Changes (2)
       âœ“ should handle user logging in mid-session 1ms
       âœ“ should handle user logging out mid-session 1ms
     âœ“ 10. Delete Operations (2)
       âœ“ should delete local save successfully 1ms
       âœ“ should handle delete errors gracefully 0ms

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯

 FAIL  client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > v4: should handle corrupted cloud data
AssertionError: expected undefined to be defined
 â¯ client/src/game/save.comprehensive.test.ts:674:42
    672|       expect(loaded).toBeDefined();
    673|       if (loaded) {
    674|         expect(loaded.cooldownDurations).toBeDefined();
       |                                          ^
    675|         expect(typeof loaded.cooldownDurations).toBe('object');
    676|       }

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed (1)
      Tests  1 failed | 54 passed (55)
   Start at  07:42:31
   Duration  278ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
~/workspace$ npm test

> rest-express@1.0.0 test
> vitest


 DEV  v4.0.14 /home/runner/workspace

 âœ“ server/referral.integration.test.ts (4 tests) 704ms
     âœ“ should return JSON content-type  646ms
 â¯ client/src/game/save.comprehensive.test.ts (55 tests | 1 failed) 1112ms
       âœ“ should save locally even when cloud save fails 61ms
       âœ“ should handle multiple consecutive cloud save failures 2ms
       âœ“ should not update lastCloudState when cloud save fails 1ms
       âœ“ should recover from intermittent cloud failures 1ms
       âœ“ v1: should detect when cloud save is newer than local save - direct cloud priority 1ms
       âœ“ v2: should detect when cloud save is newer - both saves present 1ms
       âœ“ v3: should detect newer cloud save and sync locally 1ms
       âœ“ v4: should use cloud save when timestamps indicate it is newer 1ms
       âœ“ v5: should detect newer cloud save and process referrals 1ms
       âœ“ should handle simultaneous saves from different devices 1ms
       âœ“ should preserve higher playTime when loading 1ms
       âœ“ v1: should not lose offline progress - save then login 1ms
       âœ“ v2: should preserve offline progress when authenticating 1ms
       âœ“ v3: should not lose offline progress - verify store persistence 1ms
       âœ“ v4: should preserve offline session through login 1ms
       âœ“ v5: should sync offline progress to cloud on login 1ms
       âœ“ should handle transition from offline to online with existing cloud save 2ms
       âœ“ v1: should preserve offline progress across sessions - simple 1ms
       âœ“ v2: should preserve offline progress - stay offline 0ms
       âœ“ v3: should preserve offline data with cooldowns across sessions 0ms
       âœ“ v4: should preserve offline progress through multiple sessions 1ms
       âœ“ v5: should preserve offline progress - verify IndexedDB 1ms
       âœ“ v1: should handle corrupted cooldownDurations - apply defaults 1ms
       âœ“ v2: should handle null cooldownDurations gracefully 0ms
       âœ“ v3: should add cooldownDurations when missing 1ms
       Ã— v4: should handle corrupted cloud data 9ms
       âœ“ v5: should handle multiple corrupted fields 1ms
       âœ“ should handle missing required fields 0ms
       âœ“ should handle non-serializable data in game state 1ms
       âœ“ should preserve data through JSON serialization round-trip 1ms
       âœ“ should calculate diff correctly for changed resources 1ms
       âœ“ should handle first save (no previous state for diff) 1ms
       âœ“ should detect nested object changes 2ms
       âœ“ should process unclaimed referrals on load 1ms
       âœ“ v1: should not process claimed referrals - cloud load 2ms
       âœ“ v2: should not add gold for already claimed referrals 6ms
       âœ“ v3: should skip processing for claimed referrals 1ms
       âœ“ v4: should handle multiple claimed referrals without changes 2ms
       âœ“ v5: should handle claimed referrals or empty array 0ms
       âœ“ v1: should preserve playTime - offline mode 0ms
       âœ“ v2: should preserve playTime through cloud save 0ms
       âœ“ v3: should preserve playTime in local storage 1ms
       âœ“ v4: should preserve playTime across multiple cycles 1ms
       âœ“ v5: should preserve playTime through auth change 0ms
       âœ“ should handle playTime overflow (very long sessions) 1ms
       âœ“ should reject saves with decreasing playTime 1ms
       âœ“ should handle rapid successive saves  989ms
       âœ“ should handle save during active gameplay 1ms
       âœ“ should skip save when inactivity dialog is open 1ms
       âœ“ should handle database connection failures 2ms
       âœ“ should handle concurrent load and save operations 1ms
       âœ“ should handle user logging in mid-session 1ms
       âœ“ should handle user logging out mid-session 1ms
       âœ“ should delete local save successfully 1ms
       âœ“ should handle delete errors gracefully 0ms
stdout | client/src/game/rules/resourceGains.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev [LOAD] ğŸ’¾ Local save retrieved: {
  hasLocalSave: true,
  timestamp: '2025-12-05T07:43:05.426Z',
  playTime: 1000,
  playTimeMinutes: 0,
  hasCooldowns: true,
  cooldowns: { gatherWood: 5, buildHut: 10 },
  hasCooldownDurations: true,
  cooldownDurations: { gatherWood: 5, buildHut: 10 },
  cooldownDetails: [
    { action: 'gatherWood', remaining: 5, duration: 5 },
    { action: 'buildHut', remaining: 10, duration: 10 }
  ]
}

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev [REFERRAL] ğŸ” Processing unclaimed referrals... {
  hasUser: false,
  hasReferrals: false,
  referralsCount: 0,
  referrals: undefined
}
vdev [REFERRAL] â­ï¸ Skipping - no user or no referrals

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev [LOAD] Returning local state (no auth): {
  hasCooldownDurations: true,
  cooldownDurations: { gatherWood: 5, buildHut: 10 }
}

stdout | client/src/game/save.test.ts > Game Save/Load > should handle corrupted save data gracefully
vdev [LOAD] ğŸ’¾ Local save retrieved: {
  hasLocalSave: true,
  timestamp: '2025-12-05T07:43:05.573Z',
  playTime: undefined,
  playTimeMinutes: 0,
  hasCooldowns: false,
  cooldowns: undefined,
  hasCooldownDurations: false,
  cooldownDurations: undefined,
  cooldownDetails: []
}

stdout | client/src/game/save.test.ts > Game Save/Load > should handle corrupted save data gracefully
vdev [REFERRAL] ğŸ” Processing unclaimed referrals... {
  hasUser: false,
  hasReferrals: false,
  referralsCount: 0,
  referrals: undefined
}
vdev [REFERRAL] â­ï¸ Skipping - no user or no referrals

stdout | client/src/game/save.test.ts > Game Save/Load > should handle corrupted save data gracefully
vdev [LOAD] Returning local state (no auth): { hasCooldownDurations: true, cooldownDurations: {} }

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [LOAD] ğŸ’¾ Local save retrieved: {
  hasLocalSave: true,
  timestamp: 'none',
  playTime: 1000,
  playTimeMinutes: 0,
  hasCooldowns: false,
  cooldowns: undefined,
  hasCooldownDurations: false,
  cooldownDurations: undefined,
  cooldownDetails: []
}

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [LOAD] â˜ï¸ Using cloud save (user authenticated)

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [REFERRAL] ğŸ” Processing unclaimed referrals... {
  hasUser: true,
  hasReferrals: false,
  referralsCount: 0,
  referrals: undefined
}
vdev [REFERRAL] â­ï¸ Skipping - no user or no referrals

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [LOAD] âœ… Cloud save loaded and synced locally

 âœ“ client/src/game/save.test.ts (3 tests) 168ms
 âœ“ client/src/game/rules/resourceGains.test.ts (47 tests) 453ms
 âœ“ shared/shopItems.test.ts (28 tests) 11ms
 âœ“ client/src/game/population.test.ts (14 tests) 18ms
stderr | server/stripe.test.ts > Stripe Shop Integration > createPaymentIntent > should always use server-side price, never client price
Price manipulation attempt detected for item gold_250. Client sent: 1, Server price: 99

stdout | server/stripe.test.ts > Stripe Shop Integration > verifyPayment > should verify successful payment
âœ… Purchase saved: { id: 'purchase123', item_id: 'gold_250', user_id: 'user123' }

stderr | server/stripe.test.ts > Stripe Shop Integration > verifyPayment > should reject payment with incorrect amount
Payment amount mismatch for item gold_250. Expected: 99, Got: 1

 âœ“ server/stripe.test.ts (9 tests) 15ms
 âœ“ server/auth.test.ts (2 tests) 10ms
 âœ“ server/referral.test.ts (6 tests) 7ms
stdout | client/src/game/rules/events.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

stdout | client/src/game/loop.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/rules/events.test.ts (3 tests) 24ms
stdout | client/src/game/loop.test.ts > Game Loop Production > should handle starvation when food runs out
vdev [STATE] Set Flag: starvationActive = true

stdout | client/src/game/loop.test.ts
vdev [STATS UPDATE] ğŸ“Š Updating stats in state: {
  before: {
    strength: 0,
    knowledge: 0,
    luck: 0,
    madness: 0,
    madnessFromEvents: 0
  },
  calculated: { luck: 0, strength: 0, knowledge: 0, madness: 0 }
}
vdev [STATS UPDATE] âœ… New stats object: {
  strength: 0,
  knowledge: 0,
  luck: 0,
  madness: 0,
  madnessFromEvents: 0
}

 âœ“ client/src/game/loop.test.ts (3 tests) 6ms
 âœ“ server/referral.e2e.test.ts (2 tests) 5ms

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯

 FAIL  client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > v4: should handle corrupted cloud data
AssertionError: expected undefined to be defined
 â¯ client/src/game/save.comprehensive.test.ts:674:42
    672|       expect(loaded).toBeDefined();
    673|       if (loaded) {
    674|         expect(loaded.cooldownDurations).toBeDefined();
       |                                          ^
    675|         expect(typeof loaded.cooldownDurations).toBe('object');
    676|       }

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed | 11 passed (12)
      Tests  1 failed | 175 passed (176)
   Start at  07:43:03
   Duration  3.78s (transform 1.69s, setup 0ms, import 2.12s, tests 2.53s, environment 2ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
