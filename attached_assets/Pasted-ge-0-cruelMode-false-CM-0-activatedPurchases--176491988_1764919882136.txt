ge": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1500,
        "isNewGame": false,
        "startTime": 1764919835171,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836171
      },
      "timestamp": 1764919836171,
      "playTime": 1500
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 100
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 2,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1000,
      "isNewGame": false,
      "startTime": 1764919835170,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836170
    }
  }
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 2. Multi-Device Conflicts > should handle simultaneous saves from different devices
[MOCK DB GET] storeName=lastCloudState, key=lastCloudState
[MOCK DB GET] Current mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 150
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1500,
        "isNewGame": false,
        "startTime": 1764919835171,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836171
      },
      "timestamp": 1764919836171,
      "playTime": 1500
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 100
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 2,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1000,
      "isNewGame": false,
      "startTime": 1764919835170,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836170
    }
  }
}
[MOCK DB GET] Result: {
  "resources": {
    "wood": 100
  },
  "population": {
    "current": 10,
    "max": 20,
    "workers": {
      "woodcutter": 2,
      "miner": 3,
      "farmer": 5
    }
  },
  "buildings": {},
  "items": {},
  "cooldowns": {},
  "cooldownDurations": {},
  "attackWaveTimers": {},
  "log": [],
  "events": {
    "currentEvent": null,
    "eventQueue": []
  },
  "flags": {
    "gameStarted": true,
    "hasLitFire": true
  },
  "stats": {
    "luck": 5,
    "strength": 5,
    "knowledge": 5,
    "madness": 0
  },
  "skills": {},
  "activeTab": "cave",
  "devMode": false,
  "boostMode": false,
  "effects": {},
  "bastion_stats": {
    "armor": 0,
    "damage": 0
  },
  "cruelMode": false,
  "CM": 0,
  "activatedPurchases": {},
  "feastPurchases": {},
  "loopProgress": 0,
  "isGameLoopActive": true,
  "isPaused": false,
  "isMuted": false,
  "shopNotificationSeen": false,
  "shopNotificationVisible": false,
  "authNotificationSeen": false,
  "authNotificationVisible": false,
  "mysteriousNoteShopNotificationSeen": false,
  "mysteriousNoteDonateNotificationSeen": false,
  "playTime": 1000,
  "isNewGame": false,
  "startTime": 1764919835170,
  "idleModeState": {
    "isActive": false,
    "startTime": 0,
    "needsDisplay": false
  },
  "referrals": [],
  "social_media_rewards": {},
  "lastResourceSnapshotTime": 0,
  "highlightedResources": [],
  "curseState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "frostfallState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "lastFreeGoldClaim": 0,
  "hoveredTooltips": {},
  "inactivityDialogOpen": false,
  "lastSaved": 1764919836170
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 2. Multi-Device Conflicts > should handle simultaneous saves from different devices
[MOCK DB PUT] storeName=lastCloudState, key=lastCloudState
[MOCK DB PUT] value: {
  "resources": {
    "wood": 150
  },
  "population": {
    "current": 10,
    "max": 20,
    "workers": {
      "woodcutter": 2,
      "miner": 3,
      "farmer": 5
    }
  },
  "buildings": {},
  "items": {},
  "cooldowns": {},
  "cooldownDurations": {},
  "attackWaveTimers": {},
  "log": [],
  "events": {
    "currentEvent": null,
    "eventQueue": []
  },
  "flags": {
    "gameStarted": true,
    "hasLitFire": true
  },
  "stats": {
    "luck": 5,
    "strength": 5,
    "knowledge": 5,
    "madness": 0
  },
  "skills": {},
  "activeTab": "cave",
  "devMode": false,
  "boostMode": false,
  "effects": {},
  "bastion_stats": {
    "armor": 0,
    "damage": 0
  },
  "cruelMode": false,
  "CM": 0,
  "activatedPurchases": {},
  "feastPurchases": {},
  "loopProgress": 0,
  "isGameLoopActive": true,
  "isPaused": false,
  "isMuted": false,
  "shopNotificationSeen": false,
  "shopNotificationVisible": false,
  "authNotificationSeen": false,
  "authNotificationVisible": false,
  "mysteriousNoteShopNotificationSeen": false,
  "mysteriousNoteDonateNotificationSeen": false,
  "playTime": 1500,
  "isNewGame": false,
  "startTime": 1764919835171,
  "idleModeState": {
    "isActive": false,
    "startTime": 0,
    "needsDisplay": false
  },
  "referrals": [],
  "social_media_rewards": {},
  "lastResourceSnapshotTime": 0,
  "highlightedResources": [],
  "curseState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "frostfallState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "lastFreeGoldClaim": 0,
  "hoveredTooltips": {},
  "inactivityDialogOpen": false,
  "lastSaved": 1764919836171
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 150
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1500,
        "isNewGame": false,
        "startTime": 1764919835171,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836171
      },
      "timestamp": 1764919836171,
      "playTime": 1500
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 100
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 2,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1000,
      "isNewGame": false,
      "startTime": 1764919835170,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836170
    }
  }
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 150
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1500,
        "isNewGame": false,
        "startTime": 1764919835171,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836171
      },
      "timestamp": 1764919836171,
      "playTime": 1500
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 150
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 2,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1500,
      "isNewGame": false,
      "startTime": 1764919835171,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836171
    }
  }
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 2. Multi-Device Conflicts > should preserve higher playTime when loading
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 2. Multi-Device Conflicts > should preserve higher playTime when loading
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 2. Multi-Device Conflicts > should preserve higher playTime when loading
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST] ========== should not lose progress when going from offline to online ==========

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST] Phase 1: Save while offline

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 5000,
    "isNewGame": false,
    "startTime": 1764919835175,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836175
  },
  "timestamp": 1764919836175,
  "playTime": 5000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 5000,
        "isNewGame": false,
        "startTime": 1764919835175,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836175
      },
      "timestamp": 1764919836175,
      "playTime": 5000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST] Save completed. mockPut call count: 1
[TEST] Phase 2: User logs in
[TEST] Configuring mockGet to return saved state
[TEST] Calling loadGame()...

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should not lose progress when going from offline to online
[TEST] loadGame() returned: null
[TEST] loaded?.playTime: undefined

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should handle transition from offline to online with existing cloud save
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should handle transition from offline to online with existing cloud save
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should handle transition from offline to online with existing cloud save
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST] ========== should preserve offline progress across browser sessions ==========

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST] Setup offline mode and save

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 3000,
    "isNewGame": false,
    "startTime": 1764919835179,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836179
  },
  "timestamp": 1764919836179,
  "playTime": 3000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 3000,
        "isNewGame": false,
        "startTime": 1764919835179,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836179
      },
      "timestamp": 1764919836179,
      "playTime": 3000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST] Save completed
[TEST] Simulating new session - reconfiguring mocks
[TEST] Calling loadGame()...

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 3. Offline Progress Overwrite > should preserve offline progress across browser sessions
[TEST] loadGame() returned: null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle corrupted cooldownDurations gracefully
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle corrupted cooldownDurations gracefully
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle corrupted cooldownDurations gracefully
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle corrupted cooldownDurations gracefully
[TEST] ========== should handle corrupted cooldownDurations gracefully ==========
[TEST] Setting up mockGet to return corrupted state
[TEST] Calling loadGame()...

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle corrupted cooldownDurations gracefully
[TEST] loadGame() returned: null
[TEST] loaded?.cooldownDurations: undefined

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle missing required fields
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle missing required fields
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle missing required fields
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle non-serializable data in game state
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle non-serializable data in game state
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle non-serializable data in game state
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should handle non-serializable data in game state
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 1000,
    "isNewGame": false,
    "startTime": 1764919835183,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836183
  },
  "timestamp": 1764919836183,
  "playTime": 1000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835183,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836183
      },
      "timestamp": 1764919836183,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should preserve data through JSON serialization round-trip
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should preserve data through JSON serialization round-trip
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should preserve data through JSON serialization round-trip
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 4. Data Corruption and Validation > should preserve data through JSON serialization round-trip
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 123.456,
      "stone": 789.012
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 1000,
    "isNewGame": false,
    "startTime": 1764919835185,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836185
  },
  "timestamp": 1764919836185,
  "playTime": 1000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 123.456,
          "stone": 789.012
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835185,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836185
      },
      "timestamp": 1764919836185,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should calculate diff correctly for changed resources
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should calculate diff correctly for changed resources
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should calculate diff correctly for changed resources
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should calculate diff correctly for changed resources
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 150
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 1000,
    "isNewGame": false,
    "startTime": 1764919835186,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836186
  },
  "timestamp": 1764919836186,
  "playTime": 1000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 150
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835186,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836186
      },
      "timestamp": 1764919836186,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should calculate diff correctly for changed resources
[MOCK DB PUT] storeName=lastCloudState, key=lastCloudState
[MOCK DB PUT] value: {
  "resources": {
    "wood": 150
  },
  "population": {
    "current": 10,
    "max": 20,
    "workers": {
      "woodcutter": 2,
      "miner": 3,
      "farmer": 5
    }
  },
  "buildings": {},
  "items": {},
  "cooldowns": {},
  "cooldownDurations": {},
  "attackWaveTimers": {},
  "log": [],
  "events": {
    "currentEvent": null,
    "eventQueue": []
  },
  "flags": {
    "gameStarted": true,
    "hasLitFire": true
  },
  "stats": {
    "luck": 5,
    "strength": 5,
    "knowledge": 5,
    "madness": 0
  },
  "skills": {},
  "activeTab": "cave",
  "devMode": false,
  "boostMode": false,
  "effects": {},
  "bastion_stats": {
    "armor": 0,
    "damage": 0
  },
  "cruelMode": false,
  "CM": 0,
  "activatedPurchases": {},
  "feastPurchases": {},
  "loopProgress": 0,
  "isGameLoopActive": true,
  "isPaused": false,
  "isMuted": false,
  "shopNotificationSeen": false,
  "shopNotificationVisible": false,
  "authNotificationSeen": false,
  "authNotificationVisible": false,
  "mysteriousNoteShopNotificationSeen": false,
  "mysteriousNoteDonateNotificationSeen": false,
  "playTime": 1000,
  "isNewGame": false,
  "startTime": 1764919835186,
  "idleModeState": {
    "isActive": false,
    "startTime": 0,
    "needsDisplay": false
  },
  "referrals": [],
  "social_media_rewards": {},
  "lastResourceSnapshotTime": 0,
  "highlightedResources": [],
  "curseState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "frostfallState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "lastFreeGoldClaim": 0,
  "hoveredTooltips": {},
  "inactivityDialogOpen": false,
  "lastSaved": 1764919836186
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 150
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835186,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836186
      },
      "timestamp": 1764919836186,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 150
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835186,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836186
      },
      "timestamp": 1764919836186,
      "playTime": 1000
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 150
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 2,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1000,
      "isNewGame": false,
      "startTime": 1764919835186,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836186
    }
  }
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should handle first save (no previous state for diff)
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should handle first save (no previous state for diff)
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should handle first save (no previous state for diff)
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should handle first save (no previous state for diff)
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 1000,
    "isNewGame": false,
    "startTime": 1764919835187,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836187
  },
  "timestamp": 1764919836187,
  "playTime": 1000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835187,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836187
      },
      "timestamp": 1764919836187,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should handle first save (no previous state for diff)
[MOCK DB PUT] storeName=lastCloudState, key=lastCloudState
[MOCK DB PUT] value: {
  "resources": {
    "wood": 100,
    "stone": 50,
    "gold": 200,
    "food": 75
  },
  "population": {
    "current": 10,
    "max": 20,
    "workers": {
      "woodcutter": 2,
      "miner": 3,
      "farmer": 5
    }
  },
  "buildings": {},
  "items": {},
  "cooldowns": {},
  "cooldownDurations": {},
  "attackWaveTimers": {},
  "log": [],
  "events": {
    "currentEvent": null,
    "eventQueue": []
  },
  "flags": {
    "gameStarted": true,
    "hasLitFire": true
  },
  "stats": {
    "luck": 5,
    "strength": 5,
    "knowledge": 5,
    "madness": 0
  },
  "skills": {},
  "activeTab": "cave",
  "devMode": false,
  "boostMode": false,
  "effects": {},
  "bastion_stats": {
    "armor": 0,
    "damage": 0
  },
  "cruelMode": false,
  "CM": 0,
  "activatedPurchases": {},
  "feastPurchases": {},
  "loopProgress": 0,
  "isGameLoopActive": true,
  "isPaused": false,
  "isMuted": false,
  "shopNotificationSeen": false,
  "shopNotificationVisible": false,
  "authNotificationSeen": false,
  "authNotificationVisible": false,
  "mysteriousNoteShopNotificationSeen": false,
  "mysteriousNoteDonateNotificationSeen": false,
  "playTime": 1000,
  "isNewGame": false,
  "startTime": 1764919835187,
  "idleModeState": {
    "isActive": false,
    "startTime": 0,
    "needsDisplay": false
  },
  "referrals": [],
  "social_media_rewards": {},
  "lastResourceSnapshotTime": 0,
  "highlightedResources": [],
  "curseState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "frostfallState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "lastFreeGoldClaim": 0,
  "hoveredTooltips": {},
  "inactivityDialogOpen": false,
  "lastSaved": 1764919836187
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835187,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836187
      },
      "timestamp": 1764919836187,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835187,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836187
      },
      "timestamp": 1764919836187,
      "playTime": 1000
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 100,
        "stone": 50,
        "gold": 200,
        "food": 75
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 2,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1000,
      "isNewGame": false,
      "startTime": 1764919835187,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836187
    }
  }
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should detect nested object changes
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should detect nested object changes
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should detect nested object changes
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should detect nested object changes
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 3,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 1000,
    "isNewGame": false,
    "startTime": 1764919835189,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836189
  },
  "timestamp": 1764919836189,
  "playTime": 1000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 3,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835189,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836189
      },
      "timestamp": 1764919836189,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 5. State Diffing Logic > should detect nested object changes
[MOCK DB PUT] storeName=lastCloudState, key=lastCloudState
[MOCK DB PUT] value: {
  "resources": {
    "wood": 100,
    "stone": 50,
    "gold": 200,
    "food": 75
  },
  "population": {
    "current": 10,
    "max": 20,
    "workers": {
      "woodcutter": 3,
      "miner": 3,
      "farmer": 5
    }
  },
  "buildings": {},
  "items": {},
  "cooldowns": {},
  "cooldownDurations": {},
  "attackWaveTimers": {},
  "log": [],
  "events": {
    "currentEvent": null,
    "eventQueue": []
  },
  "flags": {
    "gameStarted": true,
    "hasLitFire": true
  },
  "stats": {
    "luck": 5,
    "strength": 5,
    "knowledge": 5,
    "madness": 0
  },
  "skills": {},
  "activeTab": "cave",
  "devMode": false,
  "boostMode": false,
  "effects": {},
  "bastion_stats": {
    "armor": 0,
    "damage": 0
  },
  "cruelMode": false,
  "CM": 0,
  "activatedPurchases": {},
  "feastPurchases": {},
  "loopProgress": 0,
  "isGameLoopActive": true,
  "isPaused": false,
  "isMuted": false,
  "shopNotificationSeen": false,
  "shopNotificationVisible": false,
  "authNotificationSeen": false,
  "authNotificationVisible": false,
  "mysteriousNoteShopNotificationSeen": false,
  "mysteriousNoteDonateNotificationSeen": false,
  "playTime": 1000,
  "isNewGame": false,
  "startTime": 1764919835189,
  "idleModeState": {
    "isActive": false,
    "startTime": 0,
    "needsDisplay": false
  },
  "referrals": [],
  "social_media_rewards": {},
  "lastResourceSnapshotTime": 0,
  "highlightedResources": [],
  "curseState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "frostfallState": {
    "isActive": false,
    "startTime": 0,
    "duration": 0
  },
  "lastFreeGoldClaim": 0,
  "hoveredTooltips": {},
  "inactivityDialogOpen": false,
  "lastSaved": 1764919836189
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 3,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835189,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836189
      },
      "timestamp": 1764919836189,
      "playTime": 1000
    }
  },
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 3,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 1000,
        "isNewGame": false,
        "startTime": 1764919835189,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836189
      },
      "timestamp": 1764919836189,
      "playTime": 1000
    }
  },
  "lastCloudState": {
    "lastCloudState": {
      "resources": {
        "wood": 100,
        "stone": 50,
        "gold": 200,
        "food": 75
      },
      "population": {
        "current": 10,
        "max": 20,
        "workers": {
          "woodcutter": 3,
          "miner": 3,
          "farmer": 5
        }
      },
      "buildings": {},
      "items": {},
      "cooldowns": {},
      "cooldownDurations": {},
      "attackWaveTimers": {},
      "log": [],
      "events": {
        "currentEvent": null,
        "eventQueue": []
      },
      "flags": {
        "gameStarted": true,
        "hasLitFire": true
      },
      "stats": {
        "luck": 5,
        "strength": 5,
        "knowledge": 5,
        "madness": 0
      },
      "skills": {},
      "activeTab": "cave",
      "devMode": false,
      "boostMode": false,
      "effects": {},
      "bastion_stats": {
        "armor": 0,
        "damage": 0
      },
      "cruelMode": false,
      "CM": 0,
      "activatedPurchases": {},
      "feastPurchases": {},
      "loopProgress": 0,
      "isGameLoopActive": true,
      "isPaused": false,
      "isMuted": false,
      "shopNotificationSeen": false,
      "shopNotificationVisible": false,
      "authNotificationSeen": false,
      "authNotificationVisible": false,
      "mysteriousNoteShopNotificationSeen": false,
      "mysteriousNoteDonateNotificationSeen": false,
      "playTime": 1000,
      "isNewGame": false,
      "startTime": 1764919835189,
      "idleModeState": {
        "isActive": false,
        "startTime": 0,
        "needsDisplay": false
      },
      "referrals": [],
      "social_media_rewards": {},
      "lastResourceSnapshotTime": 0,
      "highlightedResources": [],
      "curseState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "frostfallState": {
        "isActive": false,
        "startTime": 0,
        "duration": 0
      },
      "lastFreeGoldClaim": 0,
      "hoveredTooltips": {},
      "inactivityDialogOpen": false,
      "lastSaved": 1764919836189
    }
  }
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should process unclaimed referrals on load
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should process unclaimed referrals on load
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should process unclaimed referrals on load
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should not process already claimed referrals
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should not process already claimed referrals
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should not process already claimed referrals
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should not process already claimed referrals
[TEST] ========== should not process already claimed referrals ==========

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should not process already claimed referrals
[TEST] Setting up auth mocks with claimed referrals
[TEST] Calling loadGame()...

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 6. Referral System Integration > should not process already claimed referrals
[TEST] loadGame() returned: null
[TEST] loaded?.resources: undefined

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST] ========== should preserve playTime through save/load cycle ==========

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST] Setup offline mode
[TEST] Saving game state with playTime=12345

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 12345,
    "isNewGame": false,
    "startTime": 1764919835192,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836193
  },
  "timestamp": 1764919836193,
  "playTime": 12345
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 12345,
        "isNewGame": false,
        "startTime": 1764919835192,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836193
      },
      "timestamp": 1764919836193,
      "playTime": 12345
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST] Configuring mockGet to return saved state
[TEST] Calling loadGame()...

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should preserve playTime through save/load cycle
[TEST] loadGame() returned: null
[TEST] loaded?.playTime: undefined

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should handle playTime overflow (very long sessions)
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should handle playTime overflow (very long sessions)
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should handle playTime overflow (very long sessions)
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should handle playTime overflow (very long sessions)
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 9007199254739991,
    "isNewGame": false,
    "startTime": 1764919835194,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836194
  },
  "timestamp": 1764919836194,
  "playTime": 9007199254739991
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 9007199254739991,
        "isNewGame": false,
        "startTime": 1764919835194,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836194
      },
      "timestamp": 1764919836194,
      "playTime": 9007199254739991
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should reject saves with decreasing playTime
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should reject saves with decreasing playTime
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should reject saves with decreasing playTime
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should reject saves with decreasing playTime
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 5000,
    "isNewGame": false,
    "startTime": 1764919835197,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836197
  },
  "timestamp": 1764919836197,
  "playTime": 5000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 5000,
        "isNewGame": false,
        "startTime": 1764919835197,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836197
      },
      "timestamp": 1764919836197,
      "playTime": 5000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 7. PlayTime Tracking > should reject saves with decreasing playTime
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 3000,
    "isNewGame": false,
    "startTime": 1764919835197,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836197
  },
  "timestamp": 1764919836197,
  "playTime": 3000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 5000,
        "isNewGame": false,
        "startTime": 1764919835197,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836197
      },
      "timestamp": 1764919836197,
      "playTime": 5000
    }
  },
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true
        },
        "stats": {
          "luck": 5,
          "strength": 5,
          "knowledge": 5,
          "madness": 0
        },
        "skills": {},
        "activeTab": "cave",
        "devMode": false,
        "boostMode": false,
        "effects": {},
        "bastion_stats": {
          "armor": 0,
          "damage": 0
        },
        "cruelMode": false,
        "CM": 0,
        "activatedPurchases": {},
        "feastPurchases": {},
        "loopProgress": 0,
        "isGameLoopActive": true,
        "isPaused": false,
        "isMuted": false,
        "shopNotificationSeen": false,
        "shopNotificationVisible": false,
        "authNotificationSeen": false,
        "authNotificationVisible": false,
        "mysteriousNoteShopNotificationSeen": false,
        "mysteriousNoteDonateNotificationSeen": false,
        "playTime": 3000,
        "isNewGame": false,
        "startTime": 1764919835197,
        "idleModeState": {
          "isActive": false,
          "startTime": 0,
          "needsDisplay": false
        },
        "referrals": [],
        "social_media_rewards": {},
        "lastResourceSnapshotTime": 0,
        "highlightedResources": [],
        "curseState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "frostfallState": {
          "isActive": false,
          "startTime": 0,
          "duration": 0
        },
        "lastFreeGoldClaim": 0,
        "hoveredTooltips": {},
        "inactivityDialogOpen": false,
        "lastSaved": 1764919836197
      },
      "timestamp": 1764919836197,
      "playTime": 3000
    }
  },
  "lastCloudState": {}
}

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 8. Edge Cases and Race Conditions > should handle rapid successive saves
[TEST SETUP] Creating new mock database with fresh stores
[TEST SETUP] mockOpenDB configured to return mockDB

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 8. Edge Cases and Race Conditions > should handle rapid successive saves
[TEST SETUP] Auth mocks configured - user=null, cloud save=null

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 8. Edge Cases and Race Conditions > should handle rapid successive saves
[TEST SETUP] State mocks configured
[TEST SETUP] ========================================

stdout | client/src/game/save.comprehensive.test.ts > Save Game System - Comprehensive Tests > 8. Edge Cases and Race Conditions > should handle rapid successive saves
[MOCK DB PUT] storeName=saves, key=mainSave
[MOCK DB PUT] value: {
  "gameState": {
    "resources": {
      "wood": 100,
      "stone": 50,
      "gold": 200,
      "food": 75
    },
    "population": {
      "current": 10,
      "max": 20,
      "workers": {
        "woodcutter": 2,
        "miner": 3,
        "farmer": 5
      }
    },
    "buildings": {},
    "items": {},
    "cooldowns": {},
    "cooldownDurations": {},
    "attackWaveTimers": {},
    "log": [],
    "events": {
      "currentEvent": null,
      "eventQueue": []
    },
    "flags": {
      "gameStarted": true,
      "hasLitFire": true
    },
    "stats": {
      "luck": 5,
      "strength": 5,
      "knowledge": 5,
      "madness": 0
    },
    "skills": {},
    "activeTab": "cave",
    "devMode": false,
    "boostMode": false,
    "effects": {},
    "bastion_stats": {
      "armor": 0,
      "damage": 0
    },
    "cruelMode": false,
    "CM": 0,
    "activatedPurchases": {},
    "feastPurchases": {},
    "loopProgress": 0,
    "isGameLoopActive": true,
    "isPaused": false,
    "isMuted": false,
    "shopNotificationSeen": false,
    "shopNotificationVisible": false,
    "authNotificationSeen": false,
    "authNotificationVisible": false,
    "mysteriousNoteShopNotificationSeen": false,
    "mysteriousNoteDonateNotificationSeen": false,
    "playTime": 1000,
    "isNewGame": false,
    "startTime": 1764919835198,
    "idleModeState": {
      "isActive": false,
      "startTime": 0,
      "needsDisplay": false
    },
    "referrals": [],
    "social_media_rewards": {},
    "lastResourceSnapshotTime": 0,
    "highlightedResources": [],
    "curseState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "frostfallState": {
      "isActive": false,
      "startTime": 0,
      "duration": 0
    },
    "lastFreeGoldClaim": 0,
    "hoveredTooltips": {},
    "inactivityDialogOpen": false,
    "lastSaved": 1764919836201
  },
  "timestamp": 1764919836201,
  "playTime": 1000
}
[MOCK DB PUT] Before - mockStores: {
  "saves": {},
  "lastCloudState": {}
}
[MOCK DB PUT] After - mockStores: {
  "saves": {
    "mainSave": {
      "gameState": {
        "resources": {
          "wood": 100,
          "stone": 50,
          "gold": 200,
          "food": 75
        },
        "population": {
          "current": 10,
          "max": 20,
          "workers": {
            "woodcutter": 2,
            "miner": 3,
            "farmer": 5
          }
        },
        "buildings": {},
        "items": {},
        "cooldowns": {},
        "cooldownDurations": {},
        "attackWaveTimers": {},
        "log": [],
        "events": {
          "currentEvent": null,
          "eventQueue": []
        },
        "flags": {
          "gameStarted": true,
          "hasLitFire": true