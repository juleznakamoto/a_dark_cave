

 DEV  v4.0.14 /home/runner/workspace

stderr | server/stripe.test.ts > Stripe Shop Integration > createPaymentIntent > should always use server-side price, never client price
Price manipulation attempt detected for item gold_250. Client sent: 1, Server price: 99

stderr | server/stripe.test.ts > Stripe Shop Integration > verifyPayment > should reject payment with incorrect amount
Payment amount mismatch for item gold_250. Expected: 99, Got: 1

 ❯ server/stripe.test.ts (7 tests | 1 failed) 26ms
       ✓ should create payment intent with correct amount 5ms
       ✓ should reject invalid item IDs 2ms
       ✓ should always use server-side price, never client price 5ms
       ✓ should handle great feast items correctly 1ms
       × should verify successful payment 5ms
       ✓ should reject payment with incorrect amount 4ms
       ✓ should reject non-succeeded payments 0ms
 ✓ server/referral.integration.test.ts (4 tests) 607ms
     ✓ should return JSON content-type  534ms

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Failed Tests 1 ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯

 FAIL  server/stripe.test.ts > Stripe Shop Integration > verifyPayment > should verify successful payment
TypeError: Cannot read properties of undefined (reading 'from')
 ❯ Module.verifyPayment server/stripe.ts:70:8
     68|     // Save purchase to database
     69|     const { data: purchaseData, error: purchaseError } = await supabase
     70|       .from('purchases')
       |        ^
     71|       .insert({
     72|         user_id: userId,
 ❯ server/stripe.test.ts:116:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


 Test Files  1 failed | 1 passed (9)
      Tests  1 failed | 10 passed (11)
   Start at  09:31:25
   Duration  1.58s (transform 352ms, setup 0ms, import 872ms, tests 633ms, environment 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
