 client/src/game/rules/resourceGains.test.ts (66 tests | 3 failed) 707ms
       âœ“ chopWood gains match tooltip 53ms
       âœ“ exploreCave gains match tooltip 12ms
       âœ“ ventureDeeper gains match tooltip 19ms
       âœ“ mineStone gains match tooltip 10ms
       âœ“ mineIron gains match tooltip 8ms
       âœ“ mineCoal gains match tooltip 7ms
       âœ“ mineObsidian gains match tooltip 12ms
       âœ“ hunt gains match tooltip 63ms
       âœ“ chopWood with loggers_gloves applies correct bonus 22ms
       âœ“ hunt with hunter_cloak applies correct bonus 45ms
       âœ“ mineStone with different pickaxes shows progression 7ms
       âœ“ exploreCave with different lanterns shows progression 7ms
       âœ“ mastermason_chisel reduces building costs by 5% 2ms
       âœ“ fortified storehouse reduces building costs correctly 1ms
       âœ“ blacksmith_hammer reduces crafting costs by 15% 1ms
       âœ“ boneTotems gains match tooltip 4ms
       âœ“ leatherTotems gains match tooltip 3ms
       âœ“ boneTotems with boneTemple applies 25% bonus 3ms
       âœ“ boneTotems with sacrificial_tunic applies 25% bonus 4ms
       âœ“ leatherTotems with sacrificial_tunic applies 25% bonus 3ms
       âœ“ boneTotems with both boneTemple and sacrificial_tunic stacks additively (50% total) 11ms
       âœ“ leatherTotems with both boneTemple and sacrificial_tunic stacks additively (50% total) 8ms
       âœ“ boneTotems: only tunic (no temple) gives 25% bonus 3ms
       âœ“ boneTotems: only temple (no tunic) gives 25% bonus 3ms
       âœ“ leatherTotems: only tunic (no temple) gives 25% bonus 3ms
       âœ“ leatherTotems: only temple (no tunic) gives 25% bonus 5ms
       âœ“ boneTotems: tooltip matches actual gains 4ms
       âœ“ leatherTotems: tooltip matches actual gains 17ms
       âœ“ boneTotems with sacrificial_tunic and boneTemple: tooltip matches actual gains 4ms
       Ã— boneTotems with devourer_crown applies +20 silver bonus 22ms
       Ã— boneTotems with devourer_crown and sacrificial_tunic stacks correctly 3ms
       Ã— boneTotems with devourer_crown: tooltip matches actual gains 11ms
       âœ“ leatherTotems with sacrificial_tunic and boneTemple: tooltip matches actual gains 3ms
       âœ“ boneTotems: only tunic (no temple) gives 25% bonus 3ms
       âœ“ boneTotems: only temple (no tunic) gives 25% bonus 3ms
       âœ“ leatherTotems: only tunic (no temple) gives 25% bonus 3ms
       âœ“ leatherTotems: only temple (no tunic) gives 25% bonus 3ms
       âœ“ chopWood with button upgrades increases gains 5ms
       âœ“ exploreCave with button upgrades increases gains 13ms
       âœ“ chopWood with stone axe shows baseline gains 3ms
       âœ“ chopWood with iron axe shows improved gains 3ms
       âœ“ chopWood with steel axe shows further improved gains 3ms
       âœ“ chopWood gains are doubled during active focus mode 5ms
       âœ“ exploreCave gains are doubled during active focus mode 16ms
       âœ“ hunt gains are doubled during active focus mode 20ms
       âœ“ mineCoal gains are doubled during active focus mode 5ms
       âœ“ focus mode does not apply when expired 3ms
       âœ“ focus mode tooltip shows doubled gains for chopWood 0ms
       âœ“ focus mode tooltip shows doubled gains for exploreCave 0ms
       âœ“ focus mode stacks with other bonuses (axe + focus) 4ms
       âœ“ focus mode actual gains fall within doubled tooltip range 4ms
       âœ“ multiple bonuses stack correctly for chopWood 5ms
       âœ“ multiple bonuses stack correctly for mining 9ms
       âœ“ exploreCitadel gains match tooltip 137ms
       âœ“ exploreCitadel: tooltip calculation matches actual gains 34ms
       âœ“ exploreCitadel with cave exploration bonuses 29ms
       âœ“ craftBoneTotem produces correct amount 0ms
       âœ“ craftBoneTotems5 produces correct amount 0ms
       âœ“ craftLeatherTotem produces correct amount 0ms
       âœ“ craftLeatherTotems5 produces correct amount 0ms
       âœ“ mineSulfur gains match tooltip 4ms
       âœ“ mineAdamant gains match tooltip 5ms
       âœ“ tradeGoldForFood (tier 3) produces correct amount 0ms
       âœ“ tradeGoldForStone (tier 3) produces correct amount 0ms
       âœ“ tradeGoldForTorch (tier 3) produces correct amount 0ms
       âœ“ tradeSilverForGold (tier 3) produces correct amount 0ms
stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev [LOAD] ğŸ’¾ Local save retrieved: {
  hasLocalSave: true,
  timestamp: '2025-12-21T13:30:53.571Z',
  playTime: 1000,
  playTimeMinutes: 0,
  hasCooldowns: true,
  cooldowns: { gatherWood: 5, buildHut: 10 },
  hasCooldownDurations: true,
  cooldownDurations: { gatherWood: 5, buildHut: 10 },
  cooldownDetails: [
    { action: 'gatherWood', remaining: 5, duration: 5 },
    { action: 'buildHut', remaining: 10, duration: 10 }
  ]
}

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev [REFERRAL] ğŸ” Processing unclaimed referrals... {
  hasUser: false,
  hasReferrals: false,
  referralsCount: 0,
  referrals: undefined
}
vdev [REFERRAL] â­ï¸ Skipping - no user or no referrals

stdout | client/src/game/save.test.ts > Game Save/Load > should preserve cooldowns after save/load cycle
vdev [LOAD] Returning local state (no auth): {
  hasCooldownDurations: true,
  cooldownDurations: { gatherWood: 5, buildHut: 10 }
}

stdout | client/src/game/save.test.ts > Game Save/Load > should handle corrupted save data gracefully
vdev [LOAD] ğŸ’¾ Local save retrieved: {
  hasLocalSave: true,
  timestamp: '2025-12-21T13:30:53.815Z',
  playTime: undefined,
  playTimeMinutes: 0,
  hasCooldowns: false,
  cooldowns: undefined,
  hasCooldownDurations: false,
  cooldownDurations: undefined,
  cooldownDetails: []
}

stdout | client/src/game/save.test.ts > Game Save/Load > should handle corrupted save data gracefully
vdev [REFERRAL] ğŸ” Processing unclaimed referrals... {
  hasUser: false,
  hasReferrals: false,
  referralsCount: 0,
  referrals: undefined
}
vdev [REFERRAL] â­ï¸ Skipping - no user or no referrals

stdout | client/src/game/save.test.ts > Game Save/Load > should handle corrupted save data gracefully
vdev [LOAD] Returning local state (no auth): { hasCooldownDurations: true, cooldownDurations: {} }

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [LOAD] ğŸ’¾ Local save retrieved: {
  hasLocalSave: true,
  timestamp: 'none',
  playTime: 1000,
  playTimeMinutes: 0,
  hasCooldowns: false,
  cooldowns: undefined,
  hasCooldownDurations: false,
  cooldownDurations: undefined,
  cooldownDetails: []
}

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [LOAD] ğŸ” Comparing local and cloud saves: {
  cloudPlayTime: 1500,
  localPlayTime: 1000,
  cloudTimestamp: 1766323853820,
  localTimestamp: undefined
}
vdev [LOAD] â˜ï¸ Cloud save is newer - using cloud save

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [REFERRAL] ğŸ” Processing unclaimed referrals... {
  hasUser: true,
  hasReferrals: false,
  referralsCount: 0,
  referrals: undefined
}
vdev [REFERRAL] â­ï¸ Skipping - no user or no referrals

stdout | client/src/game/save.test.ts > Game Save/Load > should merge cloud save with local save correctly
vdev [LOAD] âœ… Cloud save loaded and synced locally

 âœ“ client/src/game/save.test.ts (3 tests) 341ms
stdout | client/src/game/resourceLimits.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/resourceLimits.test.ts (56 tests) 61ms
 âœ“ client/src/game/save.logout.test.ts (9 tests) 68ms
stdout | client/src/game/rules/actionEffects.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/rules/actionEffects.test.ts (19 tests) 33ms
stdout | client/src/game/loop.resourceLimits.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/loop.resourceLimits.test.ts (13 tests) 26ms
stderr | server/auth.test.ts > Authentication > should handle session expiry gracefully
vdev Failed to get current user: Error: [vitest] No "getCachedAuthUser" export is defined on the "../client/src/lib/supabase" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError (file:///home/runner/workspace/node_modules/vitest/dist/chunks/startModuleRunner.W28wBIgJ.js:310:17)
    at Object.get (file:///home/runner/workspace/node_modules/vitest/dist/chunks/startModuleRunner.W28wBIgJ.js:383:16)
    at getCurrentUser (/home/runner/workspace/client/src/game/auth.ts:239:13)
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at /home/runner/workspace/server/auth.test.ts:54:18
    at file:///home/runner/workspace/node_modules/@vitest/runner/dist/index.js:919:20 {
  codeFrame: 'vi.mock(import("../client/src/lib/supabase"), async (importOriginal) => {\n' +
    '  const actual = await importOriginal()\n' +
    '  return {\n' +
    '    ...actual,\n' +
    '    // your mocked methods\n' +
    '  }\n' +
    '})'
}

 âœ“ server/auth.test.ts (2 tests) 20ms
stdout | client/src/game/state.resourceLimits.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/state.resourceLimits.test.ts (11 tests) 24ms
stdout | client/src/game/rules/events.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/rules/events.test.ts (3 tests) 7ms
stdout | client/src/game/loop.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

stdout | client/src/game/loop.test.ts > Game Loop Production > should handle starvation when food runs out
vdev [STATE] Set Flag: starvationActive = true

 âœ“ client/src/game/loop.test.ts (3 tests) 7ms
stdout | client/src/game/state.test.ts
vdev Registering sounds for lazy loading...
vdev Sound URLs registered for lazy loading

 âœ“ client/src/game/state.test.ts (5 tests) 6ms

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯ Failed Tests 3 â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯

 FAIL  client/src/game/rules/resourceGains.test.ts > Resource Gain Tests > Sacrifice Actions > boneTotems with devourer_crown applies +20 silver bonus
AssertionError: expected 10 to be 30 // Object.is equality

- Expected
+ Received

- 30
+ 10

 â¯ client/src/game/rules/resourceGains.test.ts:891:39
    889| 
    890|       // Devourer Crown adds flat +20 silver bonus
    891|       expect(expectedWith.silver.min).toBe(expectedWithout.silver.min + 20);
       |                                       ^
    892|       expect(expectedWith.silver.max).toBe(expectedWithout.silver.max + 20);
    893|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯

 FAIL  client/src/game/rules/resourceGains.test.ts > Resource Gain Tests > Sacrifice Actions > boneTotems with devourer_crown and sacrificial_tunic stacks correctly
AssertionError: expected 12 to be 32 // Object.is equality

- Expected
+ Received

- 32
+ 12

 â¯ client/src/game/rules/resourceGains.test.ts:913:40
    911|       const expectedMax = multipliedMax + 20;
    912| 
    913|       expect(expectedGains.silver.min).toBe(expectedMin);
       |                                        ^
    914|       expect(expectedGains.silver.max).toBe(expectedMax);
    915|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯

 FAIL  client/src/game/rules/resourceGains.test.ts > Resource Gain Tests > Sacrifice Actions > boneTotems with devourer_crown: tooltip matches actual gains
AssertionError: expected 45 to be less than or equal to 25
 â¯ client/src/game/rules/resourceGains.test.ts:939:25
    937|       const maxActual = Math.max(...actualGains.silver);
    938|       expect(minActual).toBeGreaterThanOrEqual(tooltipSilver!.min);
    939|       expect(maxActual).toBeLessThanOrEqual(tooltipSilver!.max);
       |                         ^
    940| 
    941|       // Base 10-25 + 20 bonus = 30-45

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯


 Test Files  1 failed | 11 passed (12)
      Tests  3 failed | 246 passed (249)
   Start at  13:30:52
   Duration  3.48s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
