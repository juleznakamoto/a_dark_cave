
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Failed Tests 6 ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯

 FAIL  server/stripe.exploit.test.ts > Exploit Attempt Simulations > EXPLOIT: Free Bundle Attack > should prevent attacker from getting bundle for free by manipulating client price
AssertionError: expected "vi.fn()" to be called with arguments: [ ObjectContaining {"amount": 1199} ]

Received: 

  1st vi.fn() call:

  [
-   ObjectContaining {
-     "amount": 1199,
+   {
+     "amount": 1099,
+     "currency": "usd",
+     "metadata": {
+       "currency": "usd",
+       "itemId": "advanced_bundle",
+       "itemName": "Pale King's Bundle",
+       "priceInCents": "1099",
+     },
    },
  ]


Number of calls: 1

 ❯ server/stripe.exploit.test.ts:43:41
     41| 
     42|       // Server should ALWAYS use server price
     43|       expect(mockPaymentIntents.create).toHaveBeenCalledWith(
       |                                         ^
     44|         expect.objectContaining({
     45|           amount: 1199, // NOT 0!

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/6]⎯

 FAIL  server/stripe.security.test.ts > Bundle Purchase Security Tests > Multiple Bundle Purchase Prevention > should accept payment only with exact server price
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ server/stripe.security.test.ts:105:30
    103|       const result = await verifyPayment('pi_test', 'user123', mockSupabase);
    104| 
    105|       expect(result.success).toBe(true);
       |                              ^
    106|       expect(result.itemId).toBe('advanced_bundle');
    107|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/6]⎯

 FAIL  server/stripe.security.test.ts > Bundle Purchase Security Tests > Payment Intent Creation Security > should always use server-side price for bundles
AssertionError: expected "vi.fn()" to be called with arguments: [ ObjectContaining {"amount": 1199} ]

Received: 

  1st vi.fn() call:

  [
-   ObjectContaining {
-     "amount": 1199,
+   {
+     "amount": 1099,
+     "currency": "usd",
+     "metadata": {
+       "currency": "usd",
+       "itemId": "advanced_bundle",
+       "itemName": "Pale King's Bundle",
+       "priceInCents": "1099",
+     },
    },
  ]


Number of calls: 1

 ❯ server/stripe.security.test.ts:118:41
    116|       await createPaymentIntent('advanced_bundle', undefined, undefined, 1); // Client sends…
    117| 
    118|       expect(mockPaymentIntents.create).toHaveBeenCalledWith(
       |                                         ^
    119|         expect.objectContaining({
    120|           amount: 1199, // Server enforces correct price

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/6]⎯

 FAIL  server/stripe.security.test.ts > Bundle Purchase Security Tests > Component Purchase Security > should create component purchases with price_paid=0 and bundle_id set
AssertionError: expected [] to have a length of 3 but got +0

- Expected
+ Received

- 3
+ 0

 ❯ server/stripe.security.test.ts:184:27
    182| 
    183|       // Should have 3 inserts: 1 bundle + 2 components
    184|       expect(insertCalls).toHaveLength(3);
       |                           ^
    185|       
    186|       // Bundle purchase

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/6]⎯

 FAIL  server/stripe.security.test.ts > Bundle Purchase Security Tests > Race Condition Tests > should handle concurrent purchase attempts gracefully
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ server/stripe.security.test.ts:259:32
    257|       // All should succeed (database should handle deduplication)
    258|       results.forEach(result => {
    259|         expect(result.success).toBe(true);
       |                                ^
    260|       });
    261|     });
 ❯ server/stripe.security.test.ts:258:15

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/6]⎯

 FAIL  shared/shopItems.test.ts > Shop Items Configuration > Advanced Bundle Configuration > should have correct pricing for advanced bundle
AssertionError: expected 1099 to be 1199 // Object.is equality

- Expected
+ Received

- 1199
+ 1099

 ❯ shared/shopItems.test.ts:254:28
    252|     it('should have correct pricing for advanced bundle', () => {
    253|       const bundle = SHOP_ITEMS.advanced_bundle;
    254|       expect(bundle.price).toBe(1199); // 11.99 €
       |                            ^
    255|       expect(bundle.originalPrice).toBe(2399); // 23.99 €
    256|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/6]⎯


 Test Files  3 failed | 21 passed (24)
      Tests  6 failed | 386 passed (392)
   Start at  08:26:02
   Duration  5.29s (transform 1.58s, setup 0ms, import 3.96s, tests 2.21s, environment 4ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
