# A Dark Cave: Save Game System Analysis and Recommendations

This document provides a deep analysis of the current save game system in "A Dark Cave" and offers recommendations to improve its reliability and prevent data loss.

## 1. Current Save Game Architecture

The current system uses a hybrid approach, combining local storage (IndexedDB) with cloud storage (Supabase).

- **Local Storage**: Game state is saved to IndexedDB, providing offline persistence.
- **Cloud Storage**: For authenticated users, the game synchronizes a diff of the game state to Supabase.
- **Loading Priority**: Authenticated users prioritize the cloud save, while unauthenticated users use the local save.

This is a good foundation, but the synchronization and conflict resolution logic has several critical weaknesses.

## 2. Identified Failure Scenarios

Here are the primary ways a player can lose progress:

### 2.1. Cloud Sync Failures
- **Problem**: If the Supabase save fails (due to network issues, server errors, etc.), the error is logged, but there is no retry mechanism. The local and cloud saves become out of sync, with the local save being more recent.
- **Impact**: If the user clears their browser cache or switches to a new device, they will load the older, out-of-date cloud save, and all progress made since the last successful sync will be lost.

### 2.2. Multi-Device Conflicts (Race Conditions)
- **Problem**: The system is not designed for simultaneous gameplay on multiple devices. The last device to save will overwrite any progress made on other devices. The optimistic concurrency control (OCC) currently in place is insufficient because it only checks if the `playTime` has increased, which is not a guarantee against data loss in a multi-device scenario.
- **Impact**: A player could lose hours of progress if they play on their phone and then later switch to their computer, which might have an older game state.

### 2.3. Offline Progress Overwritten
- **Problem**: If a player plays offline and then later connects to the internet, the game will prioritize the cloud save, which could be much older than the local save.
- **Impact**: All offline progress is immediately overwritten without any warning or option for the user to choose which save to keep.

## 3. Recommendations and Best Practices

To address these issues, I recommend the following changes:

### 3.1. Implement a Conflict Resolution UI
- **Recommendation**: When a discrepancy is detected between the local and cloud saves, do not automatically overwrite the local save. Instead, present the user with a clear and simple UI that shows both saves and asks them to choose which one to keep.
- **Best Practice**: Display key information for each save file, such as:
    - Last played timestamp
    - Total play time
    - Key resources (e.g., gold, population)
- **Example**: Melvor Idle does an excellent job of this. When it detects a conflict, it presents a modal with both the local and cloud saves, allowing the user to make an informed decision.

### 3.2. Create an Offline Sync Queue
- **Recommendation**: When a cloud save fails, add the save operation to a queue. The game should then periodically attempt to sync the queued saves to the server.
- **Best Practice**: Implement an exponential backoff strategy for retries to avoid overwhelming the server. The UI should also indicate the sync status to the user (e.g., "Syncing...", "Offline," "Synced").

### 3.3. Improve Session Management
- **Recommendation**: To prevent multi-device conflicts, implement a session locking mechanism. When a player starts a session, a "lock" is placed on their cloud save. If they try to play on another device, they are notified that a session is already active.
- **Best Practice**: The session lock should have a timeout to prevent players from being permanently locked out if a session does not end cleanly (e.g., browser crash). The user should also be given the option to "force" a new session, which would invalidate the old one.

### 3.4. Favor Full-State Saves Over Diffs
- **Recommendation**: While diffing can save bandwidth, it adds significant complexity and potential for data corruption. Given the relatively small size of the game state, I recommend simplifying the system by always saving the full game state.
- **Best Practice**: This eliminates a whole class of bugs related to diff creation, merging, and validation, making the save system much more robust and easier to maintain.

## 4. How Other Web Games Solve This

- **Cookie Clicker**: Uses a simple, manual save system. Players can export their save to a text file and import it on another device. This is less convenient but very reliable.
- **Melvor Idle**: Offers both automatic cloud saving (similar to A Dark Cave) and manual save exports. Its conflict resolution UI is a great example of a user-friendly approach to handling save discrepancies.
- **Kittens Game**: Also uses a manual export/import system, which is common for incremental games.

By implementing these recommendations, "A Dark Cave" can significantly improve the reliability of its save game system and provide a much better experience for players.
